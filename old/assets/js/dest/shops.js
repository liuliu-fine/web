function getLocation(){navigator.geolocation?navigator.geolocation.getCurrentPosition(showPosition,showError,{enableHighAccuracy:!0}):msg("设备不支持定位.")}function showPosition(e){var t=[e.coords.longitude,e.coords.latitude];regeocoder(t)}function showError(e){var t=decodeURIComponent(para[1]);j("#city-name").html(t),para[0]?getShops(para[0],para[0],"",""):(msg("你拒绝了定位."),window.location.href="chooseCity.vhtml?fail2")}function regeocoder(e){var t=new AMap.Geocoder({radius:1e3,extensions:"all"});t.getAddress(e,function(t,o){if("complete"===t&&"OK"===o.info){var i=(o.regeocode.formattedAddress,{});i.city=o.regeocode.addressComponent.city||o.regeocode.addressComponent.province,i.citycode=o.regeocode.addressComponent.citycode,i.longitude=e[1],i.latitude=e[0],j.cookie("citycode",JSON.stringify(i),{expires:30,path:"/"}),j("#city-name").html(i.city),getShops(i.citycode,i.citycode,i.longitude,i.latitude)}else msg("请重试！")})}function getShop(){rest("shop.shops.get",{shopId:SHOPID},function(e){setHtml(e,1)},function(){msg("系统错误！")})}function getShops(e,t,o,i){var a=j.cookie("guestId");rest("shop.guest.get",{guestId:a,city:e||t,location:e||t,latitude:o,longitude:i},function(e){setHtml(e,0)},1)}function setHtml(e,t){if(200==e.RESULT_DATA.code){var o=e.RESULT_DATA.result,i="";if(""==o.items)j("#list").html("什么也没有"),t&&j("#current").html("其它0家门店");else{1==t&&j("#current").html("其它"+o.items.length+"家门店");for(var a in o.items){var n=j("#list").html();o.items[a].originalPicUrl&&(n=n.replace(j("#img").attr("src"),o.items[a].picUrl)),n=n.replace("@id@",o.items[a].id),n=n.replace("@brandName@",o.items[a].name),n=n.replace("@cai@",o.items[a].cuisineText),n=n.replace("@address@",o.items[a].businessZoneText),n=n.replace("@money@","￥"+o.items[a].avgprice+"位"),n=n.replace("@count@",o.items[a].boxNum),n=n.replace("@table@",o.items[a].tableNum),n=n.replace("#","/"+o.items[a].id+"/index.vhtml");var r=o.items[a].distance;if(r&&(100>r?r="<100m":1e3>r?r+="m":r=1e4>r?(r/1e3).toFixed(1)+"km":(r/1e3).toFixed(0)+"km"),n=n.replace("@distance@",r||""),null!=o.items[a].activityType){var c=o.items[a].activityType,s="",l=j("#icon").html();for(var d in c)s+=l.replace("VIP","_"+c[d]);n=n.replace(j("#icon").html(),s)}i+=n}j("#list").html(i),j("#list").show()}j("#loader").hide()}else j("#loader").hide(),404e3==e.RESULT_DATA.code?j("#text").html("我们还没把店开到这哦~"):j("#text").html("所在城市没有开通上宾服务哦~"),j("#fail").show()}j(function(){var query=window.location.search.substr(1);if("other"==query)getShop();else{var para=query.split("&");if(2==para.length){var json=j.cookie("citycode"),city_name=decodeURIComponent(para[1]);j("#city-name").html(city_name),json&&""!=json?(json=eval("("+json+")"),json.citycode==para[0]?getLocation():getShops(para[0],para[0],"","")):getShops(para[0],para[0],"","")}else getLocation()}j("body").on("click",".index",function(){j.cookie("shopId",j(this).attr("id"),{expires:30,path:"/"}),window.location.href="index.vhtml"})});